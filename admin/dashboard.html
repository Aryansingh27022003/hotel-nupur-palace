<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard | Hotel Nupur Palace</title>
  <link rel="stylesheet" href="../css/style.css">

  <style>
    body { padding: 20px; font-family: Arial; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f5f5f5; }
    button { padding: 6px 10px; cursor: pointer; margin-bottom: 4px; }
    .filters input, .filters select {
      margin-right: 8px;
      padding: 6px;
    }
    small { color: #555; }
  </style>
</head>

<body>

<h1>Admin Dashboard</h1>

<!-- ================= FILTERS ================= -->
<div class="filters">
  <input type="text" id="search" placeholder="Search Booking ID / Name">

  <select id="roomFilter">
    <option value="">All Rooms</option>
    <option>Deluxe Room</option>
    <option>Dormitory</option>
    <option>Suite Room</option>
    <option>Non-Attached Room</option>
    <option>Attached Room</option>
    <option>AC Room</option>
    <option></option>

  </select>

  <select id="statusFilter">
    <option value="">All Status</option>
    <option value="PENDING_APPROVAL">Pending</option>
    <option value="APPROVED">Approved</option>
    <option value="REJECTED">Rejected</option>
  </select>

  <input type="date" id="fromDate">
  <input type="date" id="toDate">

  <button onclick="loadBookings()">üîç Apply</button>
</div>

<br>

<!-- ================= TABLE ================= -->
<table>
  <thead>
    <tr>
      <th>Booking ID</th>
      <th>Primary Guest</th>
      <th>Stay</th>
      <th>Guests</th>
      <th>Documents</th>
      <th>Refund / Rejection</th>
      <th>Status / Action</th>
    </tr>
  </thead>

  <tbody id="bookings">
    <tr>
      <td colspan="7" style="text-align:center">Loading‚Ä¶</td>
    </tr>
  </tbody>
</table>


function fixUrl(url) {
  if (!url) return "#";
  if (url.startsWith("http://") || url.startsWith("https://")) return url;
  return "https://" + url;
}

<script>
async function loadBookings() {
  try {
    const params = new URLSearchParams();

    const search = document.getElementById("search").value;
    const room = document.getElementById("roomFilter").value;
    const status = document.getElementById("statusFilter").value;
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    if (search) params.append("search", search);
    if (room) params.append("room", room);
    if (status) params.append("status", status);
    if (from && to) {
      params.append("from", from);
      params.append("to", to);
    }

    const res = await fetch(`https://hotel-nupur-palace.onrender.com/api/admin/bookings?${params.toString()}`, {
      credentials: "include"
    });

  if (!res.ok) {
    alert("Failed to load bookings");
    return;
  }


    const data = await res.json();
    const tbody = document.getElementById("bookings");

    if (!data.length) {
      tbody.innerHTML =
        `<tr><td colspan="7" style="text-align:center">No bookings found</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map(b => `
      <tr>
        <!-- BOOKING ID -->
        <td><b>${b.bookingId}</b></td>

        <!-- PRIMARY GUEST -->
        <td>
        <b>${b.name}</b><br>
        Age: ${b.age || "-"}<br>
        üìû ${b.phone}<br>
        üí¨ ${b.whatsapp || "-"}<br>
        ‚úâÔ∏è ${b.email || "-"}<br><br>

        <b>Coming From:</b> ${b.fromPlace || "-"}<br>
        <b>Purpose of Visit:</b> ${b.purpose || "-"}<br>
        <b>Refund Mode:</b> ${b.refundMode || "-"}<br>
        <b>Refund To:</b> ${b.refundValue || "-"}


        </td>


        <!-- STAY -->
        <td>
          üè® ${b.roomType}<br>
          üìÖ ${b.checkIn} ‚Üí ${b.checkOut}<br>
          üí∞ ‚Çπ${b.amount}
        </td>

        <!-- GUESTS -->
        <td>
          ${
            b.guests?.length
              ? b.guests.map((g, i) => `
                <b>Guest ${i + 1}</b><br>
                ${g.name}, ${g.age} (${g.relation})<br><br>
               <b>Guest ${i + 1} ID:</b> 
               <a href="${fixUrl(g.idProofPath)}" target="_blank">View</a>


              `).join("")
               
              : "<small>No additional guests</small>"
          }
        </td>

        <!-- DOCUMENTS -->
        <td>
          <b>Primary ID:</b>
          <a href="${fixUrl(b.idProofPath)}" target="_blank">View</a>



          ${
            b.paymentProofPath
              ? `<b>Payment Proof:</b>
                 <a href="${fixUrl(b.paymentProofPath)}" target="_blank">View</a>

`
              : `<small>No payment proof</small><br><br>`
          }

          ${
            b.refundProofPath
              ? `<b>Refund Proof:</b>
                 <a href="${fixUrl(b.refundProofPath)}" target="_blank">View</a>

`
              : ""
          }
        </td>

        <!-- REFUND / REJECTION -->
        <td>
          ${
            b.bookingStatus === "REJECTED"
              ? `
                <b>Reason:</b><br>
                ${b.rejectionReason || "-"}<br><br>
              `
              : "<small>‚Äî</small>"
          }
        </td>

        <!-- STATUS / ACTION -->
        <td>
          <b>${b.bookingStatus}</b><br>
          <small>${b.paymentStatus}</small><br><br>

          ${
            b.bookingStatus === "PENDING_APPROVAL"
              ? `
                <button onclick="approveBooking('${b.bookingId}')">‚úÖ Approve</button><br>
                <button onclick="openRejectBox('${b.bookingId}')">‚ùå Reject</button>
              `
              : b.bookingStatus === "APPROVED"
                ? `
                  ‚úÖ Approved<br>
                  <a href="${fixUrl(b.confirmationPdfPath)}" target="_blank">Download PDF</a>


                `
                : "‚ùå Rejected"
          }
        </td>
      </tr>
    `).join("");

  } catch (err) {
    console.error(err);
    alert("Dashboard error");
  }
}

async function approveBooking(bookingId) {
  if (!confirm("Approve this booking?")) return;

  const res = await fetch(`https://hotel-nupur-palace.onrender.com/api/admin/approve/${bookingId}`, {
    method: "POST",
    credentials: "include"
  });

  if (!res.ok) {
    alert("Approval failed");
    return;
  }

  alert("Booking approved");
  loadBookings();
}

function openRejectBox(bookingId) {
  document.getElementById("rejectBookingId").value = bookingId;
  document.getElementById("rejectReason").value = "";
  document.getElementById("refundProof").value = "";
  document.getElementById("rejectBox").style.display = "block";
}

function closeRejectBox() {
  document.getElementById("rejectBox").style.display = "none";
}

async function submitRejection() {
  const bookingIdInput = document.getElementById("rejectBookingId");
  const reasonInput = document.getElementById("rejectReason");
  const refundInput = document.getElementById("refundProof");

  if (!bookingIdInput || !reasonInput || !refundInput) {
    alert("Reject box not initialized properly");
    return;
  }

  const bookingId = bookingIdInput.value;
  const reason = reasonInput.value.trim();
  const refundProof = refundInput.files[0];


  if (!reason) {
    alert("Reason is mandatory");
    return;
  }

  const fd = new FormData();
  fd.append("reason", reason);
if (refundProof && refundProof.size > 10 * 1024 * 1024) {
  alert("Refund proof must be less than 10MB");
  return;
}
if (refundProof) fd.append("refundProof", refundProof);




  const res = await fetch(`https://hotel-nupur-palace.onrender.com/api/admin/reject/${bookingId}`, {
    method: "POST",
    credentials: "include",
    body: fd
  });

  if (!res.ok) {
    alert("Rejection failed");
    return;
  }

  alert("Booking rejected successfully");
  closeRejectBox();
  loadBookings();
}


/* AUTO LOAD */


loadBookings();
</script>
<!-- ================= REJECTION MODAL ================= -->
<div id="rejectBox" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  z-index:1000;
">

  <div style="
    background:#fff;
    width:420px;
    margin:80px auto;
    padding:20px;
    border-radius:6px;
  ">

    <h3>Reject Booking</h3>

    <input type="hidden" id="rejectBookingId">

    <label>Rejection Reason</label>
    <textarea id="rejectReason" rows="3"></textarea>

    
    <label>Refund Proof (Required)</label>
    <input type="file" id="refundProof" accept=".jpg,.jpeg,.png,.pdf">

    <br><br>

    <button onclick="submitRejection()">Submit Rejection</button>
    <button onclick="closeRejectBox()">Cancel</button>
  </div>
</div>


</body>
</html>
